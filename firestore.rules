rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Función helper para verificar si es admin
    // Nota: Firebase Auth normaliza los emails a minúsculas en el token
    function isAdmin() {
      return request.auth != null && request.auth.token.email != null && (
        request.auth.token.email == 'piperubiocoach@gmail.com' ||
        request.auth.token.email == 'sebassennin@gmail.com'
      );
    }
    
    // Regla para la colección de clientes
    match /clients/{clientId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir creación:
      // - Si es admin (puede crear cualquier cliente)
      // - O si el cliente está creando su propio documento (UID coincide)
      allow create: if request.auth != null && (
        isAdmin() || 
        request.auth.uid == clientId
      );
      
      // Permitir actualización:
      // - Si es admin (puede actualizar cualquier cliente)
      // - O si el cliente está actualizando su propio documento
      allow update: if request.auth != null && (
        isAdmin() || 
        request.auth.uid == clientId
      );
      
      // Permitir eliminación solo a admins
      allow delete: if isAdmin();
    }
    
    // Regla para entrenamientos de clientes
    match /clients/{clientId}/workouts/{workoutId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura solo a admins
      allow write: if isAdmin();
    }
    
    // Regla para progreso de clientes
    match /clients/{clientId}/progress/{progressId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura:
      // - Si es admin (puede ver/editar cualquier progreso)
      // - O si el cliente está actualizando su propio progreso
      allow write: if request.auth != null && (
        isAdmin() || 
        request.auth.uid == clientId
      );
    }
    
    // Regla para registros RM y PR de clientes
    match /clients/{clientId}/records/{recordId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura:
      // - Si es admin (puede ver/editar cualquier registro)
      // - O si el cliente está actualizando sus propios registros
      allow write: if request.auth != null && (
        isAdmin() || 
        request.auth.uid == clientId
      );
    }
    
    // Regla para la colección de usuarios (si existe)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Regla para la colección de ejercicios
    match /exercises/{exerciseId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura solo a admins
      allow write: if isAdmin();
    }
    
    // Regla para pagos de clientes
    match /clients/{clientId}/payments/{paymentId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura solo a admins
      allow write: if isAdmin();
    }
    
    // Regla para medidas antropométricas de clientes
    match /clients/{clientId}/anthropometric/{measureId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura solo a admins
      allow write: if isAdmin();
    }
    
    // Regla para registros diarios de carga y esfuerzo
    match /clients/{clientId}/dailyRecords/{recordId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura:
      // - Si es admin (puede ver/editar cualquier registro)
      // - O si el cliente está actualizando sus propios registros
      allow write: if request.auth != null && (
        isAdmin() || 
        request.auth.uid == clientId
      );
    }
    
    // Regla para feedback diario
    match /dailyFeedback/{feedbackId} {
      // Permitir lectura a usuarios autenticados
      allow read: if request.auth != null;
      
      // Permitir escritura:
      // - Si es admin (puede ver/editar cualquier feedback)
      // - O si el cliente está creando/actualizando su propio feedback
      //   (permitimos a cualquier usuario autenticado crear feedback, ya que el clientId
      //    puede no coincidir con el UID si los clientes se identifican por email)
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isAdmin() || 
        resource.data.clientId == request.resource.data.clientId
      );
      allow delete: if isAdmin();
    }
    
    // Regla por defecto: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

